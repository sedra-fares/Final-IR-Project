<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Document Retrieval</title>
<!-- Chart.js for analytics charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://cdn.jsdelivr.net/npm/flatpickr-year-select-plugin/dist/flatpickr-year-select-plugin.umd.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
body {
    background:#efeff1;
    font-family:"Segoe UI", sans-serif;
}
.search-box {
    margin-top:80px;
    padding:40px;
    background:white;
    border-radius:20px;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
    position: relative;
}
.result-card {
    background:white;
    border-radius:15px;
    padding:20px;
    margin-bottom:15px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    cursor:pointer;
    transition:transform .15s;
}
.result-card:hover {
    transform:scale(1.02);
}
#suggestions {
    position:absolute;
    z-index:1000;
    width:100%;
}
.meta {
    font-size:0.9em;
    color:#666;
}
#docContent p {
    margin-bottom: 0.8rem;
}
#docContent b {
    color: #495057;
}
</style>
</head>

<body>
    <div class="container position-relative">

        
        <div class="position-absolute top-0 start-0 p-0" style="z-index: 1050;">
            <div class="d-flex flex-column gap-2">
                <button class="btn btn-info btn-sm" onclick="showTopLocations()">
                    üåç Top 10 Locations
                </button>
                <button class="btn btn-success btn-sm" onclick="showTimeline()">
                    üìà Daily Timeline 
                </button>
            </div>
        </div>
    
        <!-- Main search box -->
        <div class="search-box mx-auto col-10 col-md-8 col-lg-6 text-center">
            <h2 class="mb-4">üîç Smart Document Retrieval</h2>
    
            <input id="searchInput"
                   class="form-control form-control-lg"
                   type="text"
                   placeholder="Search for documents..."
                   autocomplete="off"
                   oninput="handleAutocomplete()"
                   onkeydown="handleEnter(event)">
    
            <ul id="suggestions" class="list-group"></ul>
    
            <div class="mt-3 d-flex flex-wrap gap-2 justify-content-center align-items-center">
                <strong>Filter by:</strong>
                <button class="btn btn-outline-primary" onclick="openDateModal()">üìÖ Calendar</button>
                <button class="btn btn-outline-primary" onclick="openMapModal()">üó∫Ô∏è Location</button>
                <button class="btn btn-outline-primary" onclick="openSizeModal()">üìÑ Size</button>
                <button class="btn btn-outline-danger" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>
            </div>
    
            <p id="chosenLocation" class="mt-2 text-muted"></p>
    
            <button class="btn btn-primary mt-3 w-100" onclick="performSearch()">Search</button>
        </div>
    
        <div id="results-area" class="mt-4"></div>
    </div>
<!-- DOCUMENT MODAL -->
<div class="modal fade" id="docModal">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 id="docTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p><b>Date:</b> <span id="docDate"></span></p>
<p><b>Author:</b> <span id="docAuthor"></span></p>
<p><b>Location:</b> <span id="docLocation"></span></p>
<hr>
<p id="docContent"></p>
</div>
</div>
</div>
</div>

<!-- MAP MODAL -->
<div class="modal fade" id="mapModal">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5>Select Location</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div id="map" style="height:400px;"></div>
<p class="mt-2 text-muted" id="locationText">No location selected</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="confirmLocation()">OK</button>
</div>
</div>
</div>
</div>

<!-- DATE MODAL -->
<div class="modal fade" id="dateModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5>Select Date Range</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<label>From</label>
<input id="fromDate" class="form-control mb-2">
<label>To</label>
<input id="toDate" class="form-control">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="confirmDate()">OK</button>
</div>
</div>
</div>
</div>

<!-- SIZE MODAL -->
<div class="modal fade" id="sizeModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5>Select Result Size</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<select id="sizeSelect" class="form-select">
<option value="5">Top 5</option>
<option value="10" selected>Top 10</option>
<option value="20">Top 20</option>
<option value="50">Top 50</option>
</select>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="confirmSize()">OK</button>
</div>
</div>
</div>
</div>
<!-- TOP LOCATIONS MODAL -->
<div class="modal fade" id="topLocationsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üåç Top 10 Most Mentioned Locations</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <canvas id="topLocationsChart" height="400"></canvas>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- TIMELINE MODAL -->
  <div class="modal fade" id="timelineModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üìà Daily Document Distribution (1987)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <canvas id="timelineChart" height="400"></canvas>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE="http://127.0.0.1:5000";

let selectedFrom=null, selectedTo=null, selectedSize=10;
let tempLat=null, tempLon=null, selectedLat=null, selectedLon=null;
let locationName="";
let map, mapInitialized=false;
flatpickr("#fromDate", {
    dateFormat: "Y-m-d",
    allowInput: true
});

flatpickr("#toDate", {
    dateFormat: "Y-m-d",
    allowInput: true
});
function openMapModal(){
const modal=new bootstrap.Modal(mapModal);
modal.show();
setTimeout(()=>{ initMap(); map.invalidateSize(); },300);
}

function initMap(){
if(mapInitialized) return;
mapInitialized=true;

map=L.map("map").setView([31.9,35.2],7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker;
map.on("click",async e=>{
tempLat=e.latlng.lat;
tempLon=e.latlng.lng;
if(marker) map.removeLayer(marker);
marker=L.marker([tempLat,tempLon]).addTo(map);

const res = await fetch(
`https://nominatim.openstreetmap.org/reverse?format=json&lat=${tempLat}&lon=${tempLon}`
);
const data = await res.json();
locationName = data.display_name || "Unknown location";

locationText.innerText = `Selected: ${locationName}`;
});
}

function confirmLocation(){
selectedLat=tempLat;
selectedLon=tempLon;
document.getElementById("chosenLocation").innerText =
`üìç Selected location: ${locationName}`;
bootstrap.Modal.getInstance(mapModal).hide();
}

function openDateModal(){ new bootstrap.Modal(dateModal).show(); }
function confirmDate(){
    selectedFrom = fromDate.value ? fromDate.value + "T00:00:00" : null;
    selectedTo = toDate.value ? toDate.value + "T23:59:59" : null;  // Inclusive end
    bootstrap.Modal.getInstance(dateModal).hide();
}

function openSizeModal(){ new bootstrap.Modal(sizeModal).show(); }
function confirmSize(){
selectedSize=sizeSelect.value;
bootstrap.Modal.getInstance(sizeModal).hide();
}

function handleEnter(e){
if(e.key==="Enter"){ suggestions.innerHTML=""; performSearch(); }
}

async function handleAutocomplete(){
const q=searchInput.value.trim();
if(q.length<3){ suggestions.innerHTML=""; return; }

const res=await fetch(`${API_BASE}/autocomplete?q=${encodeURIComponent(q)}`);
const data=await res.json();
suggestions.innerHTML="";
data.forEach(t=>{
const li=document.createElement("li");
li.className="list-group-item list-group-item-action";
li.textContent=t;
li.onclick=()=>{ searchInput.value=t; suggestions.innerHTML=""; };
suggestions.appendChild(li);
});
}

function clearFilters() {
    selectedFrom = null;
    selectedTo = null;
    selectedSize = 10;
    selectedLat = null;
    selectedLon = null;
    locationName = "";

    document.getElementById("chosenLocation").innerText = "";
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    document.getElementById("sizeSelect").value = "10";


    // Optional: give feedback
    alert("All filters cleared!");
    // Or better: show a toast/message if you have Bootstrap toasts
}

async function performSearch(){
suggestions.innerHTML="";
const q=searchInput.value.trim();
if(!q) return;

let url=`${API_BASE}/search?q=${encodeURIComponent(q)}&size=${selectedSize}`;
if(selectedFrom) url+=`&from=${selectedFrom}`;
if(selectedTo) url+=`&to=${selectedTo}`;
let geoParam = "";
if (locationName) {
    geoParam = encodeURIComponent(locationName);
} else if (selectedLat && selectedLon) {
    geoParam = `${selectedLat},${selectedLon}`;
}
if (geoParam) {
    url += `&geo=${geoParam}`;
}

const res=await fetch(url);
const data=await res.json();

const resultsArea=document.getElementById("results-area");
resultsArea.innerHTML="";

data.forEach(doc=>{
const authors = doc.authors && doc.authors.length
  ? `${doc.authors[0].first_name} ${doc.authors[0].last_name}`
  : "Unknown author";

const locations = doc.locations && doc.locations.length
  ? doc.locations[0]
  : "Unknown location";

const card=document.createElement("div");
card.className="result-card";
card.innerHTML=`
<h5>${doc.title||"Untitled"}</h5>
<div class="meta">üìÖ ${doc.date||"N/A"}</div>
<div class="meta">üë§ ${authors}</div>
<div class="meta">üìç ${locations}</div>
<div class="text-muted d-block mb-2"><strong>üìä
            Relevance score: ${doc.score ? doc.score.toFixed(3) : "N/A"}</strong>
        </div>
<p class="mt-2">${(doc.content||"").substring(0,150)}...</p>
`;
card.onclick=()=>openDocument(doc, authors, locations);
resultsArea.appendChild(card);
});
}

function openDocument(doc, authors, locations){
    docTitle.innerText = doc.title || "Untitled";
    docDate.innerText = doc.date || "N/A";
    docAuthor.innerText = authors;
    docLocation.innerText = locations;

    // === Extracted Georeference Names ===
    const geoNames = doc.georeference_names && doc.georeference_names.length > 0
        ? doc.georeference_names.join(", ")
        : "None";

    // === Main Geopoint ===
    const geopoint = doc.geopoint || null;
    const geoPointText = geopoint
        ? `Lat: ${geopoint.lat.toFixed(4)}, Lon: ${geopoint.lon.toFixed(4)}`
        : "Not available";

    // === Temporal Expressions ===
    const temporalExpr = doc.temporal_expressions && doc.temporal_expressions.length > 0
        ? doc.temporal_expressions.join(", ")
        : "None";

    // === Relevance Score ===
    let scoreText = doc.score ? `Relevance score: ${doc.score.toFixed(3)}` : "Score not available";

    // Build full content
    docContent.innerHTML = `
        <small class="text-muted">${scoreText}</small><hr>
        <p><b>Extracted Georeference Names:</b> ${geoNames}</p>
        <p><b>Main Geopoint:</b> ${geoPointText}</p>
        <p><b>Temporal Expressions:</b> ${temporalExpr}</p>
        <hr>
        ${doc.content || ""}
    `;

    new bootstrap.Modal(docModal).show();
}

async function showTopLocations() {
    const res = await fetch(`${API_BASE}/analytics/top_locations`);
    const data = await res.json();

    const labels = data.map(item => item.location);
    const counts = data.map(item => item.count);

    const ctx = document.getElementById('topLocationsChart').getContext('2d');
    if (window.topChart) window.topChart.destroy();

    window.topChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Documents',
                data: counts,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });

    new bootstrap.Modal(document.getElementById('topLocationsModal')).show();
}

async function showTimeline() {
    const res = await fetch(`${API_BASE}/analytics/timeline`);
    const data = await res.json();
    console.log("Timeline data:", data);

    if (!data || Object.keys(data).length === 0) {
        alert("No timeline data available");
        return;
    }

    const labels = Object.keys(data).sort();
    const counts = labels.map(date => data[date]);

    const ctx = document.getElementById('timelineChart').getContext('2d');
    if (window.timelineChart instanceof Chart) window.timelineChart.destroy();

    window.timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Documents per Day',
                data: counts,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'Date' } },
                y: { beginAtZero: true, title: { display: true, text: 'Documents' } }
            }
        }
    });

    new bootstrap.Modal(document.getElementById('timelineModal')).show();
}

</script>

</body>
</html>
