<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Document Retrieval</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
body {
    background:#efeff1;
    font-family:"Segoe UI", sans-serif;
}
.search-box {
    margin-top:80px;
    padding:40px;
    background:white;
    border-radius:20px;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
    position: relative;
}
.result-card {
    background:white;
    border-radius:15px;
    padding:20px;
    margin-bottom:15px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    cursor:pointer;
    transition:transform .15s;
}
.result-card:hover {
    transform:scale(1.02);
}
#suggestions {
    position:absolute;
    z-index:1000;
    width:100%;
}
.meta {
    font-size:0.9em;
    color:#666;
}
</style>
</head>

<body>
<div class="container">

<div class="search-box mx-auto col-10 col-md-8 col-lg-6 text-center">
<h2 class="mb-4">üîç Smart Document Retrieval</h2>

<input id="searchInput"
       class="form-control form-control-lg"
       type="text"
       placeholder="Search for documents..."
       autocomplete="off"
       oninput="handleAutocomplete()"
       onkeydown="handleEnter(event)">

<ul id="suggestions" class="list-group"></ul>

<div class="mt-3 d-flex flex-wrap gap-3 justify-content-center align-items-center">
<strong>Filter by:</strong>
<button class="btn btn-outline-primary" onclick="openDateModal()">üìÖ Calendar</button>
<button class="btn btn-outline-primary" onclick="openMapModal()">üó∫Ô∏è Location</button>
<button class="btn btn-outline-primary" onclick="openSizeModal()">üìÑ Size</button>
</div>

<p id="chosenLocation" class="mt-2 text-muted"></p>

<button class="btn btn-primary mt-3 w-100" onclick="performSearch()">Search</button>
</div>

<div id="results-area" class="mt-4"></div>
</div>

<!-- DOCUMENT MODAL -->
<div class="modal fade" id="docModal">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 id="docTitle"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p><b>Date:</b> <span id="docDate"></span></p>
<p><b>Author:</b> <span id="docAuthor"></span></p>
<p><b>Location:</b> <span id="docLocation"></span></p>
<hr>
<p id="docContent"></p>
</div>
</div>
</div>
</div>

<!-- MAP MODAL -->
<div class="modal fade" id="mapModal">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5>Select Location</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div id="map" style="height:400px;"></div>
<p class="mt-2 text-muted" id="locationText">No location selected</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="confirmLocation()">OK</button>
</div>
</div>
</div>
</div>

<!-- DATE MODAL -->
<div class="modal fade" id="dateModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5>Select Date Range</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<label>From</label>
<input id="fromDate" class="form-control mb-2">
<label>To</label>
<input id="toDate" class="form-control">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="confirmDate()">OK</button>
</div>
</div>
</div>
</div>

<!-- SIZE MODAL -->
<div class="modal fade" id="sizeModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5>Select Result Size</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<select id="sizeSelect" class="form-select">
<option value="5">Top 5</option>
<option value="10" selected>Top 10</option>
<option value="20">Top 20</option>
<option value="50">Top 50</option>
</select>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="confirmSize()">OK</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE="http://127.0.0.1:5000";

let selectedFrom=null, selectedTo=null, selectedSize=10;
let tempLat=null, tempLon=null, selectedLat=null, selectedLon=null;
let locationName="";
let map, mapInitialized=false;

flatpickr("#fromDate",{dateFormat:"Y-m-d"});
flatpickr("#toDate",{dateFormat:"Y-m-d"});

function openMapModal(){
const modal=new bootstrap.Modal(mapModal);
modal.show();
setTimeout(()=>{ initMap(); map.invalidateSize(); },300);
}

function initMap(){
if(mapInitialized) return;
mapInitialized=true;

map=L.map("map").setView([31.9,35.2],7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker;
map.on("click",async e=>{
tempLat=e.latlng.lat;
tempLon=e.latlng.lng;
if(marker) map.removeLayer(marker);
marker=L.marker([tempLat,tempLon]).addTo(map);

const res = await fetch(
`https://nominatim.openstreetmap.org/reverse?format=json&lat=${tempLat}&lon=${tempLon}`
);
const data = await res.json();
locationName = data.display_name || "Unknown location";

locationText.innerText = `Selected: ${locationName}`;
});
}

function confirmLocation(){
selectedLat=tempLat;
selectedLon=tempLon;
document.getElementById("chosenLocation").innerText =
`üìç Selected location: ${locationName}`;
bootstrap.Modal.getInstance(mapModal).hide();
}

function openDateModal(){ new bootstrap.Modal(dateModal).show(); }
function confirmDate(){
selectedFrom=fromDate.value;
selectedTo=toDate.value;
bootstrap.Modal.getInstance(dateModal).hide();
}

function openSizeModal(){ new bootstrap.Modal(sizeModal).show(); }
function confirmSize(){
selectedSize=sizeSelect.value;
bootstrap.Modal.getInstance(sizeModal).hide();
}

function handleEnter(e){
if(e.key==="Enter"){ suggestions.innerHTML=""; performSearch(); }
}

async function handleAutocomplete(){
const q=searchInput.value.trim();
if(q.length<3){ suggestions.innerHTML=""; return; }

const res=await fetch(`${API_BASE}/autocomplete?q=${encodeURIComponent(q)}`);
const data=await res.json();
suggestions.innerHTML="";
data.forEach(t=>{
const li=document.createElement("li");
li.className="list-group-item list-group-item-action";
li.textContent=t;
li.onclick=()=>{ searchInput.value=t; suggestions.innerHTML=""; };
suggestions.appendChild(li);
});
}

async function performSearch(){
suggestions.innerHTML="";
const q=searchInput.value.trim();
if(!q) return;

let url=`${API_BASE}/search?q=${encodeURIComponent(q)}&size=${selectedSize}`;
if(selectedFrom) url+=`&from=${selectedFrom}`;
if(selectedTo) url+=`&to=${selectedTo}`;
if(selectedLat && selectedLon) url+=`&lat=${selectedLat}&lon=${selectedLon}`;

const res=await fetch(url);
const data=await res.json();

const resultsArea=document.getElementById("results-area");
resultsArea.innerHTML="";

data.forEach(doc=>{
const authors = doc.authors && doc.authors.length
  ? `${doc.authors[0].first_name} ${doc.authors[0].last_name}`
  : "Unknown author";

const locations = doc.locations && doc.locations.length
  ? doc.locations[0]
  : "Unknown location";

const card=document.createElement("div");
card.className="result-card";
card.innerHTML=`
<h5>${doc.title||"Untitled"}</h5>
<div class="meta">üìÖ ${doc.date||"N/A"}</div>
<div class="meta">üë§ ${authors}</div>
<div class="meta">üìç ${locations}</div>
<p class="mt-2">${(doc.content||"").substring(0,150)}...</p>
`;
card.onclick=()=>openDocument(doc, authors, locations);
resultsArea.appendChild(card);
});
}

function openDocument(doc, authors, locations){
docTitle.innerText=doc.title||"Untitled";
docDate.innerText=doc.date||"N/A";
docAuthor.innerText=authors;
docLocation.innerText=locations;
docContent.innerText=doc.content||"";
new bootstrap.Modal(docModal).show();
}
</script>

</body>
</html>
